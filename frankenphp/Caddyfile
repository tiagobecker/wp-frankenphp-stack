{
    # Ativa HTTP/3 + QUIC
    servers {
        protocol {
            experimental_http3
        }
    }

    # Logging básico
    debug
}

:80 {
    encode gzip zstd

    # Redireciona tudo para HTTPS quando ativado no ambiente Coolify
    @http {
        protocol http
    }
    redir @http https://{host}{uri}

    handle_path / {
        root * /app/public

        # FrankenPHP handler
        php_server * {
            worker /app/public/index.php
        }

        file_server
    }

    # Cache agressivo de assets estáticos
    @static {
        path *.png *.jpg *.jpeg *.svg *.gif *.ico *.css *.js *.webp *.avif *.ttf *.otf *.woff *.woff2 *.eot
    }
    header @static Cache-Control "public, max-age=31536000, immutable"

    # Segurança
    header {
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "camera=(), microphone=(), geolocation=()"
    }
}

# HTTPS para produção (Coolify assume domínio SSL automático)
:443 {
    tls {
        # Coolify gerencia certificados automaticamente
    }

    encode gzip zstd

    handle_path / {
        root * /app/public

        php_server * {
            worker /app/public/index.php
        }

        file_server
    }

    @static {
        path *.png *.jpg *.jpeg *.svg *.gif *.ico *.css *.js *.webp *.avif *.ttf *.otf *.woff *.woff2 *.eot
    }
    header @static Cache-Control "public, max-age=31536000, immutable"

    header {
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "camera=(), microphone=(), geolocation=()"
    }
}