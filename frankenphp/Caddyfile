{
    # Ativa HTTP/3 globalmente
    servers {
        listener_wrappers {
            tls
            http
        }
    }

    # Logs estruturados (ótimo para Coolify)
    logging {
        output stdout
        format json
    }

    # Melhora performance de workers do frankenphp
    frankenphp {
        worker 4
    }
}

:80 {
    # Pasta pública do WordPress
    root * /app/public

    # Encoders modernos
    encode zstd gzip

    # Usa o PHP embed do FrankenPHP
    php_server frankenphp

    # Assets cacheados agressivamente
    @static_assets {
        path *.css *.js *.jpg *.jpeg *.png *.gif *.webp *.svg *.ico *.woff *.woff2 *.ttf *.otf
    }
    header @static_assets Cache-Control "public, max-age=31536000, immutable"

    # Cache para páginas não autenticadas (melhor performance WP)
    @wp_cache {
        not path /wp-admin/*
        not header Cookie *wordpress_logged_in*
    }
    header @wp_cache Cache-Control "public, max-age=120, stale-while-revalidate=30"

    # Segurança avançada OWASP
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "accelerometer=(), geolocation=(), microphone=(), camera=(), interest-cohort=()"
        X-XSS-Protection "1; mode=block"
    }

    # Remove headers sensíveis
    header -Server
    header -X-Powered-By

    # Rewrite padrão WordPress
    try_files {path} {path}/ /index.php

    file_server
}

# Opcional: endpoint de health-check para o Coolify
:80/health {
    respond "OK" 200
}