{
    log {
        output stdout
        format json
    }
}

:80 {
    root * /app/public

    # Serve cache estático gerado pelo WP Super Cache (se existir)
    @supercache {
        file {
            try_files /wp-content/cache/supercache{uri}/index.html /wp-content/cache/supercache{host}{uri}/index.html
        }
    }
    handle @supercache {
        file_server
        header Cache-Control "public, max-age=60, stale-while-revalidate=30"
    }

    # Static assets caching
    @static_assets {
        path *.css *.js *.jpg *.jpeg *.png *.gif *.svg *.ico *.webp *.avif *.ttf *.otf *.woff *.woff2
    }
    header @static_assets Cache-Control "public, max-age=31536000, immutable"

    # Não cachear admin, login, REST API, feed e cookies de usuário logado
    @no_cache {
        path /wp-admin/* /wp-login.php /xmlrpc.php /wp-json/*
        header_regexp Cookie "wordpress_logged_in_.*"
    }

    # Se não for cache estático e não for no-no_cache, passa para o PHP
    route {
        try_files {path} {path}/ /index.php
        php_server frankenphp
    }

    # Headers de segurança
    header {
        Strict-Transport-Security "max-age=31536000; preload"
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "camera=(), microphone=(), geolocation=()"
    }

    # healthcheck
    @health path /health
    handle @health {
        respond "OK" 200
    }
}